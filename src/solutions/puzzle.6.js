const LINE_SEP = '\n';
const OBS = '#';
const EMPTY = '.';
const GUARD_UP = '^';
const GUARD_DOWN = 'v';
const GUARD_LEFT = '<';
const GUARD_RIGHT = '>';
const GUARD_PATH = 'X';
const GUARD = [GUARD_UP, GUARD_DOWN, GUARD_LEFT, GUARD_RIGHT];

export function solvePart1() {
    const map = getMapMatrix();
    let guardRow = -1;
    let guardCol = -1;

    do {
        guardRow = map.findIndex(row => GUARD.some(dir => row.includes(dir)));
        guardCol = map[guardRow].findIndex(cell => [GUARD_UP, GUARD_DOWN, GUARD_LEFT, GUARD_RIGHT].includes(cell));
        getNextTurnForGuard(map, guardRow, guardCol);
        drawMap(map);
    } while (guardRow > 0 && guardCol > 0 && guardRow < map.length - 1 && guardCol < map[0].length - 1);

    return map.reduce((acc, row) => acc + row.filter(cell => cell === GUARD_PATH).length, 0);
}

export function solvePart2() {
    let originMap = getMapMatrix();
    let map = deepCopyMatrix(originMap);
    let guardRow = -1;
    let guardCol = -1;
    var lastCornerPositions = [];
    let isInLoop = false;
    let sumOfGuardStuckInLoop = 0;

    for (let row = 0; row <= map.length - 1; row++) {

        for (let col = 0; col <= map[row].length - 1; col++) {
            map = deepCopyMatrix(originMap);
            guardRow = -1;
            guardCol = -1;
            lastCornerPositions = [];
            isInLoop = false;
            const c = map[row][col];

            if (c === EMPTY) {
                map[row][col] = OBS;
                // drawMap(map);
                do {
                    guardRow = map.findIndex(row => GUARD.some(dir => row.includes(dir)));
                    guardCol = map[guardRow].findIndex(cell => [GUARD_UP, GUARD_DOWN, GUARD_LEFT, GUARD_RIGHT].includes(cell));
                    lastCornerPositions.push({ row: guardRow, col: guardCol });
                    getNextTurnForGuard(map, guardRow, guardCol);
                    isInLoop = guardIsInLoop2(lastCornerPositions);
                } while (lastCornerPositions.length < 1000 && !isInLoop && (guardRow > 0 && guardCol > 0 && guardRow < map.length - 1 && guardCol < map[0].length - 1));

                if (isInLoop) {
                    drawMap(map);
                    sumOfGuardStuckInLoop += 1;
                    console.log(`sumOfGuardStuckInLoop ${sumOfGuardStuckInLoop} ${row} ${col}`, lastCornerPositions);
                }
                map[row][col] = EMPTY;
            }
        }
    }

    return sumOfGuardStuckInLoop;
}

function getNextTurnForGuard(map, row, col) {
    const dir = map[row][col];
    map[row][col] = GUARD_PATH;
    switch (dir) {
        case GUARD_UP:
            for (let i = row - 1; i >= 0; i--) {
                if (map[i][col] === OBS) {
                    map[i + 1][col] = GUARD_RIGHT;
                    break;
                } else {
                    map[i][col] = i > 0 ? GUARD_PATH : GUARD_UP;
                }
            }
            break;
        case GUARD_DOWN:
            for (let i = row + 1; i < map.length; i++) {
                if (map[i][col] === OBS) {
                    map[i - 1][col] = GUARD_LEFT;
                    break;
                } else {
                    map[i][col] = i < map.length - 1 ? GUARD_PATH : GUARD_DOWN;
                }
            }
            break;
        case GUARD_LEFT:
            for (let i = col - 1; i >= 0; i--) {
                if (map[row][i] === OBS) {
                    map[row][i + 1] = GUARD_UP;
                    break;
                } else {
                    map[row][i] = i > 0 ? GUARD_PATH : GUARD_LEFT;
                }
            }
            break;
        case GUARD_RIGHT:
            for (let i = col + 1; i < map[row].length; i++) {
                if (map[row][i] === OBS) {
                    map[row][i - 1] = GUARD_DOWN;
                    break;
                } else {
                    map[row][i] = i < map[row].length - 1 ? GUARD_PATH : GUARD_RIGHT;
                }
            }
            break;
        default:
            console.error("Guard is facing unknown direction");
    }
}

function getMapMatrix() {
    return input.split(LINE_SEP).map(line => line.split(''));
}

function deepCopyMatrix(matrix) {
    return matrix.map(row => [...row]);
}

function drawMap(map) {
    map.forEach(row => console.debug(row.join('')));
}

function guardIsInLoop(lastCornerPositions) {
    let guardIsInLoop = false;
    const lastPos = lastCornerPositions[lastCornerPositions.length - 1];
    let previousPosOfDuplicate = -1;
    for (let i = lastCornerPositions.length - 2; i >= 0; i--) {
        if (lastCornerPositions[i].row === lastPos.row && lastCornerPositions[i].col === lastPos.col) {
            previousPosOfDuplicate = i;
            break;
        }
    }

    if (previousPosOfDuplicate >= 0) {
        const delta = (lastCornerPositions.length - 1) - previousPosOfDuplicate;
        if (delta > 1 && lastCornerPositions.length >= delta * 2) {
            guardIsInLoop = true;
            for (let i = 0; i < delta; i++) {
                const firstCycle = lastCornerPositions[lastCornerPositions.length - 1 - i];
                const duplicateCycle = lastCornerPositions[previousPosOfDuplicate - i];
                if (firstCycle.row != duplicateCycle.row || firstCycle.col != duplicateCycle.col) {
                    guardIsInLoop = false;
                    break;
                }
            }
        }
    }

    return guardIsInLoop;
}

function guardIsInLoop2(lastCornerPositions) {
    let guardIsInLoop = false;
    const lastPos = lastCornerPositions[lastCornerPositions.length - 1];
    const lastPos2 = lastCornerPositions[lastCornerPositions.length - 2];
    return lastCornerPositions.filter(x => x.row === lastPos.row && x.col === lastPos.col).length > 1 &&
        lastCornerPositions.filter(x => x.row === lastPos2.row && x.col === lastPos2.col).length > 1;
}

var testInput =
    `....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...`;

var input = `..........................#.#........................................#..........................................#.............#...
....................#...............................#.......#...............................#..........................#...#......
.....#.......#...................................................#..#....................##.........#...#...........#.....#..#.#..
............#...#....#..............##...#.#....#........................#...................................................#....
....#......##........................................................................#..#..##...................##.........#......
.............##.........#..##..............#...............#....................#..................#......#...................#...
...........#.....................#.......#.................#....#.#..............#...........#.........................#..........
.#............#..............................................................#........#................#........#.................
..........................#..#.......................................................#.........#..................................
.........#....#................#...........#...................##............#..........#.........................................
....#...................................#....#.........#..........#.......................#..............................#........
.............................#.....##.............................................................#..#...........................#
....#................#...#.#..........#.#....#..................#..........#......#.............................#.................
......................#............#......................................##................#..........#..#.............#.........
..#........#............#.....###....##...........................#..............................#.....#..........................
.....#...........#..#.........#...................#.#.................#........#............#.....#........#......................
..........................................................................................................................#.......
..#...................#.....................................................................#....................#................
...............#............................#....#..........#...................#............#...............#..#.................
................#...........................#...........................................#.........................#...............
..........#.......#.........................##.................................................#...................##..#..........
.#.........#...#..#............................................#........................#.......................................#.
........#...........###..................#...........#..............#.....................#................#......................
.............#....#............................#.#..............................#..#................................#.............
...#.....#..........#...........#..................................................#........#...........#..#..........##.....#....
...............................................................................#...................#........................##....
......#.#...........................#.................#.................................................................#.........
..................................#............................................................................#.#................
........................#.......#.....#..........#..#.............##.................#..............#............##...............
......#........................#........................................#......#..................................................
...............##.......#..............................................................................................#..........
....#...................................................................................#.........#..........#..............#.....
.....#.............#.........................#.........#........#................#.#.........................#..........#.........
.............#......##...........#................#...#.#.....#......................................#..........#.................
...........................#............#................#................#...........................#.....#.....................
.......#.................#..#..............#................................#....#........#.......#.............#....#....##......
........................................................#........................................................................#
.................#.........................................#.......#.......#......#...#.#.................##......................
..........#............#..............................................#........................................#..........#..#....
..............#......................................................#......#................................#....................
...#........#.............#.................#......#.......................#..............................##........#.............
.....................#............................................................#............#...............................#..
......#.....#..............................................................#...............#...#..................................
.......................................#..#.......#...#..............#.................................................#..........
...................................................................................................#........................#.....
....#.....#.......................................................#.....#......#...................#............#.................
..............#....#.....................#........................................##....#...#.....................................
.....#...............................................................#............#............................#..................
........................#..........................#..............................................................................
#..............#...........................................................................#......................................
...................................#...#....................................................................#.....................
................#......#.........#.................#...........................#..................................................
......#...#................#...............#..................................................#...................................
.......................#.............#..#....................#............#.......................................................
.....................#.#.....................................#................................##.............#.#..#..............#
.....................................#...#...........................#....................................................##...#..
.................#..#............#.............................#..#................................................##.............
...#...........................................#.................................................#.............#.............##...
..................#....#....#.#..........................#.............#................#............................#............
.........................#................#.#..#.#............^.........................................................#.........
.....#...............#............................................................................................................
.#.......................................................................................#...............#....#.............#.....
......#................................#............#............................................................#................
.#.....................#..............#.............#.......................#.....#....#.#.#...................#....#.............
..................................................................#........#............................#..#.#...............#....
.#.....................#......#........#.......#.................#.......................#..#.....................................
..............#..#..#.............................................#....................#......#...................................
.................##.#............................##..#...............................................................#....#.......
...........#..#........................#.#..........#.................##.....#...#.........................#.#...#............#...
.....................#..........#..#..............................................................................................
.......#...............................#..#.........#.....................................#......#...................#............
..............................##.#........#.......#..#.....#......................................................................
..................#......................#.....................................###...#............................##..............
...................................#...................................#...........................#....##..#.....................
.....................#.....#.#.........#.........................#.....#.......#..........#.......................#...............
...........#..................................................................................................#...................
......#............................#.............................#..........................................#.....##..............
...........................#...........................................................#.............................#..........#.
..........................................#..........................................#......#...............#.....................
..............##.........#........................................................................................................
.....................#............#..#......#..#......................................................................#...........
........#.........#.....................#.................................#...#.#....#....#......................#.#..............
......#...........#............................................................#..............#......................#............
.....#.....................#.....#.........#.............................#....#............................#......................
..#..............................................................................................................#...#............
..............#.......................#........#............................................#.......................#.............
........................................#....................................................................................##...
.......#..#.......#.................#.#.................#...........#............#........#.#.........#...........#.#..........#..
.....##.......................#.........................#.........................#...........#.........#.....#...........#.......
..........................#.....................#...............................#.............................#...................
.....#..........#.............#...#..........................#.#...................#...........................#......#...........
......................................#.......#.........#......................................#..................................
......#...#....................#................#...#.......#.............#............#...........#.....#........................
........................................#............#......................................................#............#........
..#.......#....#..........................................................................#......................##..#.......#....
................#...................................................#..........................................#..................
...........#........................................................................................#.............................
..................#........................................#.....#...........................#..................#.................
........#.......#.....#...........#.......................................................#.........#.............................
.............#.....#.#............................#...................................................................#...........
...............#...................................#...........................#.............#..#..................#..##..........
.#...............................#....#.....................#...................................#...................#...#.........
..................#..#.#..................................................................................................#.......
.........#.....#...#.........#........#...........................................#..................#.#.#......#.................
.........#......#.......................#........#.............................#...#................#...........................#.
...#.........................................................................................##........................#..........
.....................................#...........................................................#.#...#......#...............#...
#.....................#.........#.................................................#.....................................#.........
............##.............................#...............................................#......................................
.#.................#........................#.................................................................#.....#.............
.....#.......................#......................#.................#....#....................................................#.
.............................#..................................................................#.#...............................
........#.......#.....##..........................................#...................#.........#...........#...#...#...#.........
..........#.#...#.....................#............................................................##.........##..................
...................#..............##.....#...........#.#.......#................................................#...............#.
............................................................#....#.............#....##.......#...#...#................#...........
......#...............................#.........#...................#....#..............#.................#.......................
....................................#.....................#....#....#.................#...............#...........................
.................................#.............#.#...................................#..............#...#.....#.............#.....
......................#..................#.............#.................#................................................#.......
.....................##.......................#.............#...#........#..........#.....#............................##...#.....
..........................#.....................#...........#.....................................................#...............
................#.....................................................................................................#...........
........#......#.......................#....................................#................................#....................
.....................................#............................................................................................
........#..........#.........#.#................##................#...#..........................#.........#......##.......#......
.......#...................#................................#..#.......................#..............................#...........
............#.....................................#......#........................#..........#.............................#......
..#...........#...........#...................................#............#...#.....#......................................#.....
................................................................#...........#.......##.......#..........#............#............`;